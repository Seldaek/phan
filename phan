#!/usr/bin/env php
<?php declare(strict_types=1);

// Grab these before we define our own classes
$internal_class_name_list = get_declared_classes();
$internal_interface_name_list = get_declared_interfaces();
$internal_trait_name_list = get_declared_traits();
$internal_function_name_list = get_defined_functions()['internal'];

require_once(__DIR__.'/Phan/Bootstrap.php');

use \Phan\CLI;
use \Phan\CodeBase;
use \Phan\Config;
use \Phan\Log;
use \Phan\Phan;

// Create our CLI interface and load arguments
$cli = new CLI();

// Read the code base from a saved state or create a
// new one if none exists
if (CodeBase::storedCodeBaseExists()) {
    $code_base = CodeBase::fromStoredCodeBase();
} else {
    $code_base = new CodeBase(
        $internal_class_name_list,
        $internal_interface_name_list,
        $internal_trait_name_list,
        $internal_function_name_list
    );
}

$code_base = new CodeBase(
    $internal_class_name_list,
    $internal_interface_name_list,
    $internal_trait_name_list,
    $internal_function_name_list
);

ini_set('msgpack.php_only', 0);

print "start\n";
$code_base->store();
$code_base = CodeBase::fromStoredCodeBase();
print "done\n";

// Analyze the file list provided via the CLI
(new Phan)->analyzeFileList(
    $code_base,
    $cli->getFileList()
);
